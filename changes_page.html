<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SND@LHC Software: Major changes</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">SND@LHC Software
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('changes_page.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Major changes</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#ch-methods">Solution methods</a><ul><li class="level2"><a href="#ch-inv">Inversion</a></li>
<li class="level2"><a href="#ch-diag">Diagonalization</a></li>
<li class="level2"><a href="#ch-minres">Minimal Residual Method (MINRES)</a></li>
<li class="level2"><a href="#ch-minresqlp">Advanced Minimal Residual Method (MINRES-QLP)</a></li>
<li class="level2"><a href="#ch-elim-const">Elimination of constraints</a></li>
</ul>
</li>
<li class="level1"><a href="#ch-regul">Regularization</a></li>
<li class="level1"><a href="#ch-locfit">Local fit</a></li>
<li class="level1"><a href="#ch-openmp">Parallelization</a></li>
<li class="level1"><a href="#ch-compression">Compressed sparse matrix</a></li>
<li class="level1"><a href="#ch-gzip">Gzipped C binary files</a></li>
<li class="level1"><a href="#ch-transf">Transformation from FORTRAN77 to Fortran90</a></li>
<li class="level1"><a href="#ch-memmanage">Memory management</a></li>
<li class="level1"><a href="#ch-readbuf">Read buffer size</a></li>
<li class="level1"><a href="#ch-numbin">Number of binary files</a></li>
</ul>
</div>
<div class="textblock"><p>Major changes with respect to the draft manual.</p>
<h1><a class="anchor" id="ch-methods"></a>
Solution methods</h1>
<p>The following methods to obtain the solution <picture><source srcset="form_0_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\Vek{x}$" src="form_0.png"/></picture> from a linear equation system <picture><source srcset="form_1_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\Vek{A}\cdot\Vek{x}=\Vek{b}$" src="form_1.png"/></picture> are implemented: </p>
<h2><a class="anchor" id="ch-inv"></a>
Inversion</h2>
<p>The solution and the covariance matrix <picture><source srcset="form_2_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\Vek{A}^{-1}$" src="form_2.png"/></picture> are obtained by inversion of <picture><source srcset="form_3_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\Vek{A}$" src="form_3.png"/></picture>. Available are the value, error and global correlation for all global parameters. The matrix inversion <a class="el" href="mpnum_8f90.html#a24d99a263ffebf0cbb2a8839f259c816">routine</a> has been <a class="el" href="changes_page.html#ch-openmp">parallelized</a> and can be used for up to several 10000 parameters. </p>
<h2><a class="anchor" id="ch-diag"></a>
Diagonalization</h2>
<p>The solution and the covariance matrix <picture><source srcset="form_2_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\Vek{A}^{-1}$" src="form_2.png"/></picture> are obtained by diagonalization of <picture><source srcset="form_3_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\Vek{A}$" src="form_3.png"/></picture>. Available are the value, error, global correlation and eigenvalue (and eigenvector) for all global parameters. </p>
<h2><a class="anchor" id="ch-minres"></a>
Minimal Residual Method (MINRES)</h2>
<p>The solution is obtained by minimizing <picture><source srcset="form_4_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\Vert\Vek{A}\cdot\Vek{x}-\Vek{b}\Vert_2$" src="form_4.png"/></picture> iteratively. <a class="el" href="namespaceminresmodule.html#a40c0425bcdfa65d4aee85e574ed249fc">MINRES</a> [<a class="el" href="/home/runner/work/sndsw/sndsw/millepede/pede.f90#ref_sec">ref 8</a>] is a special case of the generalized minimal residual method (GMRES) for symmetric matrices. Preconditioning with a band matrix of zero or finite <a class="el" href="namespacempmod.html#a5c18a685730f9b6f5e79316ffb84dd56">bandwidth</a> is possible. Individual columns <picture><source srcset="form_5_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\Vek{c_i}$" src="form_5.png"/></picture> of the covariance matrix can be calculated by solving <picture><source srcset="form_6_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\Vek{A}\cdot\Vek{c}_i=\Vek{1}_i$" src="form_6.png"/></picture> where <picture><source srcset="form_7_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\Vek{1}_i$" src="form_7.png"/></picture> is the i-th column on the unit matrix. The most time consuming part (<a class="el" href="pede_8f90.html#ad7828f3b25225915586ac1d5a1a98206">product</a> matrix times vector per iteration) has been <a class="el" href="changes_page.html#ch-openmp">parallelized</a>. Available are the value for all (and optionally error, global correlation for few) global parameters. </p>
<h2><a class="anchor" id="ch-minresqlp"></a>
Advanced Minimal Residual Method (MINRES-QLP)</h2>
<p>The <a class="el" href="namespaceminresqlpmodule.html#a5351016a0939b6b51b3390b1e6aa6731">MINRES-QLP</a> implementation [<a class="el" href="/home/runner/work/sndsw/sndsw/millepede/pede.f90#ref_sec">ref 9</a>] is a MINRES evolution with improved norm estimates and stopping conditions (leading potentially to different numbers of internal iterations). Internally it uses QLP instead of the QR factorization in MINRES which should be numerically superior and allows to find for singular systems the minimal length (pseudo-inverse) solution.</p>
<p>The default behavior is to start (the internal iterations) with QR factorization and to switch to QLP if the (estimated) matrix condition exceeds <a class="el" href="option_page.html#cmd-mrestranscond">mrtcnd</a>. Pure QR or QLP factorization can be enforced by <a class="el" href="option_page.html#cmd-mresmode">mrmode</a>.</p>
<h2><a class="anchor" id="ch-elim-const"></a>
Elimination of constraints</h2>
<p>As alternative to the Lagrange multiplier method the solution by elimination has been added for problems with linear equality constraints. A QL factorization (with Householder reflections) of the transposed constraints matrix is used to transform to an unconstrained problem. For sparse matrix storage the sparsity of the global matrix is preserved.</p>
<h1><a class="anchor" id="ch-regul"></a>
Regularization</h1>
<p>Optionally a term <picture><source srcset="form_8_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\tau\cdot\Vert\Vek{x}\Vert$" src="form_8.png"/></picture> can be added to the objective function (to be minimized) where <picture><source srcset="form_0_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\Vek{x}$" src="form_0.png"/></picture> is the vector of global parameters weighted with the inverse of their individual pre-sigma values.</p>
<h1><a class="anchor" id="ch-locfit"></a>
Local fit</h1>
<p>In case the local fit is a track fit with proper description of multiple scattering in the detector material additional local parameters have to be introduced for each scatterer and solution by <em>inversion</em> can get time consuming (~ <picture><source srcset="form_9_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$n_{lp}^3$" src="form_9.png"/></picture> for <picture><source srcset="form_10_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$n_{lp}$" src="form_10.png"/></picture> local parameters). For trajectories based on <b>broken lines</b> [<a class="el" href="/home/runner/work/sndsw/sndsw/millepede/pede.f90#ref_sec">ref 4,6</a>] the corresponding matrix <picture><source srcset="form_11_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\Vek{\Gamma}$" src="form_11.png"/></picture> has a bordered band structure ( <picture><source srcset="form_12_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\Gamma_{ij}=0$" src="form_12.png"/></picture> for <picture><source srcset="form_13_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\min(i,j)&gt;b$" src="form_13.png"/></picture> (border size) and <picture><source srcset="form_14_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$|i-j|&gt;m$" src="form_14.png"/></picture> (bandwidth)). With <em>root-free Cholesky decomposition</em> the time for the solution is linear and for the calculation of <picture><source srcset="form_15_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\Gamma^{-1}$" src="form_15.png"/></picture> (needed for the construction of the global matrix) quadratic in <picture><source srcset="form_10_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$n_{lp}$" src="form_10.png"/></picture>. For each local fit the structure of <picture><source srcset="form_11_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\Vek{\Gamma}$" src="form_11.png"/></picture> is checked and the faster solution method selected automatically.</p>
<h1><a class="anchor" id="ch-openmp"></a>
Parallelization</h1>
<p>The code has been largely parallelized using <a href="www.openmp.org">OpenMP&trade;</a>. This includes the reading of binary files, the local fits, the construction of the sparsity structure and filling of the global matrix and the global fit (except by diagonalization). The number of threads is set by the command <a class="el" href="option_page.html#cmd-threads">threads</a>.</p>
<p><b>Caching</b>. The records are read in blocks into a <em>read cache</em> and processed from there in parallel, each record by a single thread. For the filling of the global matrix the (zero-compressed) update matrices ( <picture><source srcset="form_16_dark.png" media="(prefers-color-scheme: dark)"/><img class="formulaInl" alt="$\Vek{\D C}_1+\Vek{\D C}_2$" src="form_16.png"/></picture> from equations (15), (16)) produced by each local fit are collected in a <em>write cache</em>. After processing the block of records this is used to update the global matrix in parallel, each row by a single thread. The total cache size can be changed by the command <a class="el" href="option_page.html#cmd-cache">cache</a>.</p>
<h1><a class="anchor" id="ch-compression"></a>
Compressed sparse matrix</h1>
<p>In sparse storage mode for each row the list of column indices (and values) for the non-zero elements are stored. With compression regions of continous column indices are represented by the first index and their number (packed into a single 32bit integer). Compression is selected by the command <a class="el" href="option_page.html#cmd-compress">compress</a>. In addition rare elements can be neglected (,histogrammed) or stored in single instead of double precision according to the <a class="el" href="option_page.html#cmd-pairentries">pairentries</a> command.</p>
<h1><a class="anchor" id="ch-gzip"></a>
Gzipped C binary files</h1>
<p>The <a href="zlib.net">zlib</a> can be used to directly read <em>gzipped</em> C binary files. In this case reading with multiple threads (each file by single thread) can speed up the decompression.</p>
<h1><a class="anchor" id="ch-transf"></a>
Transformation from FORTRAN77 to Fortran90</h1>
<p>The <b>Millepede</b> source code has been formally transformed from <em>fixed form</em> FORTRAN77 to <em>free form</em> Fortran90 (using TO_F90 by Alan Miller) and (most parts) modernized:</p><ul>
<li><code>IMPLICIT NONE</code> everywhere. Unused variables removed.</li>
<li><code>COMMON</code> blocks replaced by <code>MODULEs</code>.</li>
<li>Backward <code>GOTOs</code> replaced by proper <code>DO</code> loops.</li>
<li><code>INTENT</code> (input/output) of arguments described.</li>
<li>Code documented with doxygen.</li>
</ul>
<p>Unused parts of the code (like the interactive mode) have been removed. The reference compiler for the Fortran90 version is gcc-4.6.2 (gcc-4.4.4 works too).</p>
<h1><a class="anchor" id="ch-memmanage"></a>
Memory management</h1>
<p>The memory management for dynamic data structures (matrices, vectors, ..) has been changed from a subdivided <em>static</em> <code>COMMON</code> block to <em>dynamic</em> (<code>ALLOCATABLE</code>) Fortran90 arrays. One <b>Pede</b> executable is now sufficient for all application sizes.</p>
<h1><a class="anchor" id="ch-readbuf"></a>
Read buffer size</h1>
<p>In the first loop over all binary files a preset <a class="el" href="namespacempmod.html#a4984f1c03a4dbe4fc004e0fe4cae6793">read buffer size</a> is used. Too large records are skipped, but the maximal record length is still being updated. If any records had to be skipped the read buffer size is afterwards adjusted according to the maximal record length and the first loop is repeated.</p>
<h1><a class="anchor" id="ch-numbin"></a>
Number of binary files</h1>
<p>The number of binary files has no hard-coded limit anymore, but is calculated from the steering file and resources (file names, descriptors, ..) are allocated dynamically. Some resources may be limited by the system. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">SNDSW Class Reference</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
