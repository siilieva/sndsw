<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SND@LHC Software: minresmodule Module Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">SND@LHC Software
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('namespaceminresmodule.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions/Subroutines</a>  </div>
  <div class="headertitle"><div class="title">minresmodule Module Reference</div></div>
</div><!--header-->
<div class="contents">

<p>MINRES solves symmetric systems Ax = b or min ||Ax - b||_2, where the matrix A may be indefinite and/or singular.  
<a href="namespaceminresmodule.html#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:a40c0425bcdfa65d4aee85e574ed249fc" id="r_a40c0425bcdfa65d4aee85e574ed249fc"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceminresmodule.html#a40c0425bcdfa65d4aee85e574ed249fc">minres</a> (n, aprod, msolve, b, shift, checka, <a class="el" href="mpnum_8f90.html#a1be727b806123cdbd7ae0695df918243">precon</a>, x, itnlim, nout, rtol, istop, itn, anorm, acond, rnorm, arnorm, ynorm)</td></tr>
<tr class="memdesc:a40c0425bcdfa65d4aee85e574ed249fc"><td class="mdescLeft">&#160;</td><td class="mdescRight">Solution of linear equation system.  <br /></td></tr>
<tr class="separator:a40c0425bcdfa65d4aee85e574ed249fc"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>MINRES solves symmetric systems Ax = b or min ||Ax - b||_2, where the matrix A may be indefinite and/or singular. </p>
<pre class="fragment"> The software for MINRES (f90 version) is provided by SOL, Stanford University
 under the terms of the OSI Common Public License (CPL):
 http://www.opensource.org/licenses/cpl1.0.php

 Contributors:
     Chris Paige &lt;chris@cs.mcgill.ca&gt;
     Sou-Cheng Choi &lt;scchoi@stanford.edu&gt;

     Michael Saunders &lt;saunders@stanford.edu&gt;
     Systems Optimization Laboratory (SOL)
     Stanford University
     Stanford, CA 94305-4026, USA
     (650)723-1875

 09 Oct 2007: F90 version constructed from the F77 version.
              Initially used compiler option -r8, but this is nonstandard.
 15 Oct 2007: Test on Arnorm = ||Ar|| added to recognize singular systems.
 15 Oct 2007: Temporarily used real(8) everywhere.
 16 Oct 2007: Use minresDataModule to define dp = selected_real_kind(15).
              We need "use minresDataModule"
              at the beginning of modules AND inside interfaces.

              g95 compiles successfully with the following options:
   g95 -c -g -O0 -pedantic -Wall -Wextra -fbounds-check -ftrace=full minresModule.f90</pre><p> +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ </p>
</div><h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="a40c0425bcdfa65d4aee85e574ed249fc" name="a40c0425bcdfa65d4aee85e574ed249fc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a40c0425bcdfa65d4aee85e574ed249fc">&#9670;&#160;</a></span>minres()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public minresmodule::minres </td>
          <td>(</td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">external subroutine(integer, intent(in) n, real(dp), dimension(n), intent(in) x, real(dp), dimension(n), intent(out) y)&#160;</td>
          <td class="paramname"><em>aprod</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">external subroutine(integer, intent(in) n, real(dp), dimension(n), intent(in) x, real(dp), dimension(n), intent(out) y)&#160;</td>
          <td class="paramname"><em>msolve</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(dp), dimension(n), intent(in)&#160;</td>
          <td class="paramname"><em>b</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(dp), intent(in)&#160;</td>
          <td class="paramname"><em>shift</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>checka</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>precon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(dp), dimension(n), intent(out)&#160;</td>
          <td class="paramname"><em>x</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>itnlim</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>nout</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(dp), intent(in)&#160;</td>
          <td class="paramname"><em>rtol</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(out)&#160;</td>
          <td class="paramname"><em>istop</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(out)&#160;</td>
          <td class="paramname"><em>itn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(dp), intent(out)&#160;</td>
          <td class="paramname"><em>anorm</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(dp), intent(out)&#160;</td>
          <td class="paramname"><em>acond</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(dp), intent(out)&#160;</td>
          <td class="paramname"><em>rnorm</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(dp), intent(out)&#160;</td>
          <td class="paramname"><em>arnorm</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(dp), intent(out)&#160;</td>
          <td class="paramname"><em>ynorm</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Solution of linear equation system. </p>
<pre class="fragment">-------------------------------------------------------------------

 MINRES  is designed to solve the system of linear equations

    Ax = b

 or the least-squares problem

    min ||Ax - b||_2,

 where A is an n by n symmetric matrix and b is a given vector.
 The matrix A may be indefinite and/or singular.

 1. If A is known to be positive definite, the Conjugate Gradient
 Method might be preferred, since it requires the same number
 of iterations as MINRES but less work per iteration.

 2. If A is indefinite but Ax = b is known to have a solution
 (e.g. if A is nonsingular), SYMMLQ might be preferred,
 since it requires the same number of iterations as MINRES
 but slightly less work per iteration.

 The matrix A is intended to be large and sparse.  It is accessed
 by means of a subroutine call of the form
 SYMMLQ development:

    call Aprod ( n, x, y )

 which must return the product y = Ax for any given vector x.


 More generally, MINRES is designed to solve the system

    (A - shift*I) x = b
 or
    min ||(A - shift*I) x - b||_2,

 where  shift  is a specified scalar value.  Again, the matrix
 (A - shift*I) may be indefinite and/or singular.
 The work per iteration is very slightly less if  shift = 0.

 Note: If  shift  is an approximate eigenvalue of  A
 and  b  is an approximate eigenvector,  x  might prove to be
 a better approximate eigenvector, as in the methods of
 inverse iteration and/or Rayleigh-quotient iteration.
 However, we're not yet sure on that -- it may be better to use SYMMLQ.

 A further option is that of preconditioning, which may reduce
 the number of iterations required.  If M = C C' is a positive
 definite matrix that is known to approximate  (A - shift*I)
 in some sense, and if systems of the form  My = x  can be
 solved efficiently, the parameters precon and Msolve may be
 used (see below).  When  precon = .true., MINRES will
 implicitly solve the system of equations

    P (A - shift*I) P' xbar  =  P b,

 i.e.             Abar xbar  =  bbar
 where                    P  =  C**(-1),
                       Abar  =  P (A - shift*I) P',
                       bbar  =  P b,

 and return the solution       x  =  P' xbar.
 The associated residual is rbar  =  bbar - Abar xbar
                                  =  P (b - (A - shift*I)x)
                                  =  P r.

 In the discussion below, eps refers to the machine precision.

 Parameters
 ----------

 n       input      The dimension of the matrix A.
 b(n)    input      The rhs vector b.
 x(n)    output     Returns the computed solution x.

 Aprod   external   A subroutine defining the matrix A.
                       call Aprod ( n, x, y )
                    must return the product y = Ax
                    without altering the vector x.

 Msolve  external   An optional subroutine defining a
                    preconditioning matrix M, which should
                    approximate (A - shift*I) in some sense.
                    M must be positive definite.

                       call Msolve( n, x, y )

                    must solve the linear system My = x
                    without altering the vector x.

                    In general, M should be chosen so that Abar has
                    clustered eigenvalues.  For example,
                    if A is positive definite, Abar would ideally
                    be close to a multiple of I.
                    If A or A - shift*I is indefinite, Abar might
                    be close to a multiple of diag( I  -I ).

 checkA  input      If checkA = .true., an extra call of Aprod will
                    be used to check if A is symmetric.  Also,
                    if precon = .true., an extra call of Msolve
                    will be used to check if M is symmetric.

 precon  input      If precon = .true., preconditioning will
                    be invoked.  Otherwise, subroutine Msolve
                    will not be referenced; in this case the
                    actual parameter corresponding to Msolve may
                    be the same as that corresponding to Aprod.

 shift   input      Should be zero if the system Ax = b is to be
                    solved.  Otherwise, it could be an
                    approximation to an eigenvalue of A, such as
                    the Rayleigh quotient b'Ab / (b'b)
                    corresponding to the vector b.
                    If b is sufficiently like an eigenvector
                    corresponding to an eigenvalue near shift,
                    then the computed x may have very large
                    components.  When normalized, x may be
                    closer to an eigenvector than b.

 nout    input      A file number.
                    If nout &gt; 0, a summary of the iterations
                    will be printed on unit nout.

 itnlim  input      An upper limit on the number of iterations.

 rtol    input      A user-specified tolerance.  MINRES terminates
                    if it appears that norm(rbar) is smaller than
                       rtol * norm(Abar) * norm(xbar),
                    where rbar is the transformed residual vector,
                       rbar = bbar - Abar xbar.

                    If shift = 0 and precon = .false., MINRES
                    terminates if norm(b - A*x) is smaller than
                       rtol * norm(A) * norm(x).

 istop   output     An integer giving the reason for termination...

          -1        beta2 = 0 in the Lanczos iteration; i.e. the
                    second Lanczos vector is zero.  This means the
                    rhs is very special.
                    If there is no preconditioner, b is an
                    eigenvector of A.
                    Otherwise (if precon is true), let My = b.
                    If shift is zero, y is a solution of the
                    generalized eigenvalue problem Ay = lambda My,
                    with lambda = alpha1 from the Lanczos vectors.

                    In general, (A - shift*I)x = b
                    has the solution         x = (1/alpha1) y
                    where My = b.

           0        b = 0, so the exact solution is x = 0.
                    No iterations were performed.

           1        Norm(rbar) appears to be less than
                    the value  rtol * norm(Abar) * norm(xbar).
                    The solution in  x  should be acceptable.

           2        Norm(rbar) appears to be less than
                    the value  eps * norm(Abar) * norm(xbar).
                    This means that the residual is as small as
                    seems reasonable on this machine.

           3        Norm(Abar) * norm(xbar) exceeds norm(b)/eps,
                    which should indicate that x has essentially
                    converged to an eigenvector of A
                    corresponding to the eigenvalue shift.

           4        Acond (see below) has exceeded 0.1/eps, so
                    the matrix Abar must be very ill-conditioned.
                    x may not contain an acceptable solution.

           5        The iteration limit was reached before any of
                    the previous criteria were satisfied.

           6        The matrix defined by Aprod does not appear
                    to be symmetric.
                    For certain vectors y = Av and r = Ay, the
                    products y'y and r'v differ significantly.

           7        The matrix defined by Msolve does not appear
                    to be symmetric.
                    For vectors satisfying My = v and Mr = y, the
                    products y'y and r'v differ significantly.

           8        An inner product of the form  x' M**(-1) x
                    was not positive, so the preconditioning matrix
                    M does not appear to be positive definite.

                    If istop &gt;= 5, the final x may not be an
                    acceptable solution.

 itn     output     The number of iterations performed.

 Anorm   output     An estimate of the norm of the matrix operator
                    Abar = P (A - shift*I) P',   where P = C**(-1).

 Acond   output     An estimate of the condition of Abar above.
                    This will usually be a substantial
                    under-estimate of the true condition.

 rnorm   output     An estimate of the norm of the final
                    transformed residual vector,
                       P (b  -  (A - shift*I) x).

 ynorm   output     An estimate of the norm of xbar.
                    This is sqrt( x'Mx ).  If precon is false,
                    ynorm is an estimate of norm(x).
-------------------------------------------------------------------
 MINRES is an implementation of the algorithm described in
 the following reference:

 C. C. Paige and M. A. Saunders (1975),
 Solution of sparse indefinite systems of linear equations,
 SIAM J. Numer. Anal. 12(4), pp. 617-629.
-------------------------------------------------------------------


 MINRES development:
    1972: First version, similar to original SYMMLQ.
          Later lost @#%*!!
    Oct 1995: Tried to reconstruct MINRES from
              1995 version of SYMMLQ.
 30 May 1999: Need to make it more like LSQR.
              In middle of major overhaul.
 19 Jul 2003: Next attempt to reconstruct MINRES.
              Seems to need two vectors more than SYMMLQ.  (w1, w2)
              Lanczos is now at the top of the loop,
              so the operator Aprod is called in just one place
              (not counting the initial check for symmetry).
 22 Jul 2003: Success at last.  Preconditioning also works.
              minres.f added to http://www.stanford.edu/group/SOL/.

 16 Oct 2007: Added a stopping rule for singular systems,
              as derived in Sou-Cheng Choi's PhD thesis.
              Note that ||Ar|| small =&gt; r is a null vector for A.
              Subroutine minrestest2 in minresTestModule.f90
              tests this option.  (NB: Not yet working.)
-------------------------------------------------------------------</pre> 
<p class="definition">Definition at line <a class="el" href="minresModule_8f90_source.html#l00294">294</a> of file <a class="el" href="minresModule_8f90_source.html">minresModule.f90</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  297</span> </div>
<div class="line"><span class="lineno">  298</span>    <span class="keywordtype">integer</span>,  <span class="keywordtype">intent(in)</span>    :: n, itnlim, nout</div>
<div class="line"><span class="lineno">  299</span>    <span class="keywordtype">logical</span>,  <span class="keywordtype">intent(in)</span>    :: checkA, precon</div>
<div class="line"><span class="lineno">  300</span><span class="keywordtype">    real</span>(dp), <span class="keywordtype">intent(in)</span>    :: b(n)</div>
<div class="line"><span class="lineno">  301</span><span class="keywordtype">    real</span>(dp), <span class="keywordtype">intent(in)</span>    :: shift, rtol</div>
<div class="line"><span class="lineno">  302</span><span class="keywordtype">    real</span>(dp), <span class="keywordtype">intent(out)</span>   :: x(n)</div>
<div class="line"><span class="lineno">  303</span>    <span class="keywordtype">integer</span>,  <span class="keywordtype">intent(out)</span>   :: istop, itn</div>
<div class="line"><span class="lineno">  304</span><span class="keywordtype">    real</span>(dp), <span class="keywordtype">intent(out)</span>   :: Anorm, Acond, rnorm, Arnorm, ynorm</div>
<div class="line"><span class="lineno">  305</span> </div>
<div class="line"><span class="lineno">  306</span>    <span class="keyword">interface</span></div>
<div class="line"><span class="lineno">  307</span>       <span class="keyword">subroutine </span>aprod (n,x,y)                   <span class="comment">! y := A*x</span></div>
<div class="line"><span class="lineno">  308</span>         <span class="keywordtype">use       </span><a class="code hl_namespace" href="namespaceminresdatamodule.html">minresdatamodule</a></div>
<div class="line"><span class="lineno">  309</span>         <span class="keywordtype">integer</span>,  <span class="keywordtype">intent(in)</span>    :: n</div>
<div class="line"><span class="lineno">  310</span><span class="keywordtype">         real</span>(dp), <span class="keywordtype">intent(in)</span>    :: x(n)</div>
<div class="line"><span class="lineno">  311</span><span class="keywordtype">         real</span>(dp), <span class="keywordtype">intent(out)</span>   :: y(n)</div>
<div class="line"><span class="lineno">  312</span>       <span class="keyword">end subroutine </span>aprod</div>
<div class="line"><span class="lineno">  313</span> </div>
<div class="line"><span class="lineno">  314</span>       <span class="keyword">subroutine </span>msolve(n,x,y)                   <span class="comment">! Solve M*y = x</span></div>
<div class="line"><span class="lineno">  315</span>         <span class="keywordtype">use       </span><a class="code hl_namespace" href="namespaceminresdatamodule.html">minresdatamodule</a></div>
<div class="line"><span class="lineno">  316</span>         <span class="keywordtype">integer</span>,  <span class="keywordtype">intent(in)</span>    :: n</div>
<div class="line"><span class="lineno">  317</span><span class="keywordtype">         real</span>(dp), <span class="keywordtype">intent(in)</span>    :: x(n)</div>
<div class="line"><span class="lineno">  318</span><span class="keywordtype">         real</span>(dp), <span class="keywordtype">intent(out)</span>   :: y(n)</div>
<div class="line"><span class="lineno">  319</span>       <span class="keyword">end subroutine </span>msolve</div>
<div class="line"><span class="lineno">  320</span>    <span class="keyword">end interface</span></div>
<div class="line"><span class="lineno">  321</span> </div>
<div class="line"><span class="lineno">  322</span><span class="comment">!     Local arrays and variables</span></div>
<div class="line"><span class="lineno">  323</span><span class="keywordtype">      real</span>(dp)  :: r1(n), r2(n), v(n), w(n), w1(n), w2(n), y(n)</div>
<div class="line"><span class="lineno">  324</span><span class="keywordtype">      real</span>(dp)  :: alfa  , beta  , beta1 , cs    ,          &amp;</div>
<div class="line"><span class="lineno">  325</span>                   dbar  , delta , denom , diag  ,          &amp;</div>
<div class="line"><span class="lineno">  326</span>                   eps   , epsa  , epsln , epsr  , epsx  ,  &amp;</div>
<div class="line"><span class="lineno">  327</span>                   gamma , gbar  , gmax  , gmin  ,          &amp;</div>
<div class="line"><span class="lineno">  328</span>                   oldb  , oldeps, qrnorm, phi   , phibar,  &amp;</div>
<div class="line"><span class="lineno">  329</span>                   rhs1  , rhs2  , rnorml, rootl ,          &amp;</div>
<div class="line"><span class="lineno">  330</span>                   Arnorml,        relArnorml,              &amp;</div>
<div class="line"><span class="lineno">  331</span>                   s     , sn    , t     , tnorm2, ynorm2, z</div>
<div class="line"><span class="lineno">  332</span>      <span class="keywordtype">integer</span>   :: i</div>
<div class="line"><span class="lineno">  333</span>      <span class="keywordtype">logical</span>   :: debug, prnt</div>
<div class="line"><span class="lineno">  334</span> </div>
<div class="line"><span class="lineno">  335</span>    <span class="comment">! Local constants</span></div>
<div class="line"><span class="lineno">  336</span><span class="keywordtype">      real</span>(dp),         <span class="keywordtype">parameter</span> :: zero =  0.0,  one = 1.0</div>
<div class="line"><span class="lineno">  337</span><span class="keywordtype">      real</span>(dp),         <span class="keywordtype">parameter</span> :: ten  = 10.0</div>
<div class="line"><span class="lineno">  338</span>      <span class="keywordtype">character(len=*)</span>, <span class="keywordtype">parameter</span> :: enter = <span class="stringliteral">&#39; Enter MINRES.  &#39;</span></div>
<div class="line"><span class="lineno">  339</span>      <span class="keywordtype">character(len=*)</span>, <span class="keywordtype">parameter</span> :: exitt = <span class="stringliteral">&#39; Exit  MINRES.  &#39;</span></div>
<div class="line"><span class="lineno">  340</span>      <span class="keywordtype">character(len=*)</span>, <span class="keywordtype">parameter</span> :: msg(-1:8) =                  &amp;</div>
<div class="line"><span class="lineno">  341</span>        (/ <span class="stringliteral">&#39;beta2 = 0.  If M = I, b and x are eigenvectors of A&#39;</span>, &amp; <span class="comment">! -1</span></div>
<div class="line"><span class="lineno">  342</span>           <span class="stringliteral">&#39;beta1 = 0.  The exact solution is  x = 0           &#39;</span>, &amp; <span class="comment">!  0</span></div>
<div class="line"><span class="lineno">  343</span>           <span class="stringliteral">&#39;Requested accuracy achieved, as determined by rtol &#39;</span>, &amp; <span class="comment">!  1</span></div>
<div class="line"><span class="lineno">  344</span>           <span class="stringliteral">&#39;Reasonable accuracy achieved, given eps            &#39;</span>, &amp; <span class="comment">!  2</span></div>
<div class="line"><span class="lineno">  345</span>           <span class="stringliteral">&#39;x has converged to an eigenvector                  &#39;</span>, &amp; <span class="comment">!  3</span></div>
<div class="line"><span class="lineno">  346</span>           <span class="stringliteral">&#39;Acond has exceeded 0.1/eps                         &#39;</span>, &amp; <span class="comment">!  4</span></div>
<div class="line"><span class="lineno">  347</span>           <span class="stringliteral">&#39;The iteration limit was reached                    &#39;</span>, &amp; <span class="comment">!  5</span></div>
<div class="line"><span class="lineno">  348</span>           <span class="stringliteral">&#39;Aprod  does not define a symmetric matrix          &#39;</span>, &amp; <span class="comment">!  6</span></div>
<div class="line"><span class="lineno">  349</span>           <span class="stringliteral">&#39;Msolve does not define a symmetric matrix          &#39;</span>, &amp; <span class="comment">!  7</span></div>
<div class="line"><span class="lineno">  350</span>           <span class="stringliteral">&#39;Msolve does not define a pos-def preconditioner    &#39;</span> /) <span class="comment">!  8</span></div>
<div class="line"><span class="lineno">  351</span>    <span class="comment">!-------------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  352</span> </div>
<div class="line"><span class="lineno">  353</span>    <span class="keywordtype">intrinsic</span>       :: abs, dot_product, epsilon, min, max, sqrt</div>
<div class="line"><span class="lineno">  354</span> </div>
<div class="line"><span class="lineno">  355</span>    <span class="comment">! Print heading and initialize.</span></div>
<div class="line"><span class="lineno">  356</span> </div>
<div class="line"><span class="lineno">  357</span>    debug = .false.</div>
<div class="line"><span class="lineno">  358</span>    eps   = epsilon(eps)</div>
<div class="line"><span class="lineno">  359</span>    <span class="keywordflow">if</span> (nout &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><span class="lineno">  360</span>       <span class="keyword">write</span>(nout, 1000) enter, n, checka, <a class="code hl_function" href="mpnum_8f90.html#a1be727b806123cdbd7ae0695df918243">precon</a>, itnlim, rtol, shift</div>
<div class="line"><span class="lineno">  361</span><span class="keywordflow">    end if</span></div>
<div class="line"><span class="lineno">  362</span>    istop  = 0</div>
<div class="line"><span class="lineno">  363</span>    itn    = 0</div>
<div class="line"><span class="lineno">  364</span>    anorm  = zero</div>
<div class="line"><span class="lineno">  365</span>    acond  = zero</div>
<div class="line"><span class="lineno">  366</span>    rnorm  = zero</div>
<div class="line"><span class="lineno">  367</span>    ynorm  = zero</div>
<div class="line"><span class="lineno">  368</span>    x(1:n) = zero</div>
<div class="line"><span class="lineno">  369</span>    arnorml = zero</div>
<div class="line"><span class="lineno">  370</span>    gmin = zero</div>
<div class="line"><span class="lineno">  371</span>    gmax = zero</div>
<div class="line"><span class="lineno">  372</span> </div>
<div class="line"><span class="lineno">  373</span>    <span class="comment">!-------------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  374</span>    <span class="comment">! Set up y and v for the first Lanczos vector v1.</span></div>
<div class="line"><span class="lineno">  375</span>    <span class="comment">! y = beta1 P&#39; v1, where P = C**(-1).</span></div>
<div class="line"><span class="lineno">  376</span>    <span class="comment">! v is really P&#39; v1.</span></div>
<div class="line"><span class="lineno">  377</span>    <span class="comment">!-------------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  378</span>    y      = b</div>
<div class="line"><span class="lineno">  379</span>    r1     = b</div>
<div class="line"><span class="lineno">  380</span>    <span class="keywordflow">if</span> ( <a class="code hl_function" href="mpnum_8f90.html#a1be727b806123cdbd7ae0695df918243">precon</a> ) <span class="keyword">call </span>msolve( n, b, y )</div>
<div class="line"><span class="lineno">  381</span>    beta1  = dot_product(b,y)</div>
<div class="line"><span class="lineno">  382</span> </div>
<div class="line"><span class="lineno">  383</span>    <span class="keywordflow">if</span> (beta1 &lt; zero) <span class="keywordflow">then</span>     <span class="comment">! M must be indefinite.</span></div>
<div class="line"><span class="lineno">  384</span>       istop = 8</div>
<div class="line"><span class="lineno">  385</span>       <span class="keywordflow">go to</span> 900</div>
<div class="line"><span class="lineno">  386</span><span class="keywordflow">    end if</span></div>
<div class="line"><span class="lineno">  387</span> </div>
<div class="line"><span class="lineno">  388</span>    <span class="keywordflow">if</span> (beta1 == zero) <span class="keywordflow">then</span>    <span class="comment">! b = 0 exactly.  Stop with x = 0.</span></div>
<div class="line"><span class="lineno">  389</span>       istop = 0</div>
<div class="line"><span class="lineno">  390</span>       <span class="keywordflow">go to</span> 900</div>
<div class="line"><span class="lineno">  391</span><span class="keywordflow">    end if</span></div>
<div class="line"><span class="lineno">  392</span> </div>
<div class="line"><span class="lineno">  393</span>    beta1  = sqrt( beta1 )     <span class="comment">! Normalize y to get v1 later.</span></div>
<div class="line"><span class="lineno">  394</span> </div>
<div class="line"><span class="lineno">  395</span>    <span class="comment">!-------------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  396</span>    <span class="comment">! See if Msolve is symmetric.</span></div>
<div class="line"><span class="lineno">  397</span>    <span class="comment">!-------------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  398</span>    <span class="keywordflow">if</span> (checka  .and.  <a class="code hl_function" href="mpnum_8f90.html#a1be727b806123cdbd7ae0695df918243">precon</a>) <span class="keywordflow">then</span></div>
<div class="line"><span class="lineno">  399</span>       <span class="keyword">call </span>msolve( n, y, r2 )</div>
<div class="line"><span class="lineno">  400</span>       s      = dot_product(y ,y )</div>
<div class="line"><span class="lineno">  401</span>       t      = dot_product(r1,r2)</div>
<div class="line"><span class="lineno">  402</span>       z      = abs(s - t)</div>
<div class="line"><span class="lineno">  403</span>       epsa   = (s + eps) * eps**0.33333</div>
<div class="line"><span class="lineno">  404</span>       <span class="keywordflow">if</span> (z &gt; epsa) <span class="keywordflow">then</span></div>
<div class="line"><span class="lineno">  405</span>          istop = 7</div>
<div class="line"><span class="lineno">  406</span>          <span class="keywordflow">go to</span> 900</div>
<div class="line"><span class="lineno">  407</span><span class="keywordflow">       end if</span></div>
<div class="line"><span class="lineno">  408</span><span class="keywordflow">    end if</span></div>
<div class="line"><span class="lineno">  409</span> </div>
<div class="line"><span class="lineno">  410</span>    <span class="comment">!-------------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  411</span>    <span class="comment">! See if Aprod  is symmetric.  Initialize Arnorm.</span></div>
<div class="line"><span class="lineno">  412</span>    <span class="comment">!-------------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  413</span>    <span class="keywordflow">if</span> (checka) <span class="keywordflow">then</span></div>
<div class="line"><span class="lineno">  414</span>       <span class="keyword">call </span>aprod ( n, y, w )</div>
<div class="line"><span class="lineno">  415</span>       <span class="keyword">call </span>aprod ( n, w, r2 )</div>
<div class="line"><span class="lineno">  416</span>       s      = dot_product(w,w )</div>
<div class="line"><span class="lineno">  417</span>       t      = dot_product(y,r2)</div>
<div class="line"><span class="lineno">  418</span>       z      = abs(s - t)</div>
<div class="line"><span class="lineno">  419</span>       epsa   = (s + eps) * eps**0.33333</div>
<div class="line"><span class="lineno">  420</span>       <span class="keywordflow">if</span> (z &gt; epsa) <span class="keywordflow">then</span></div>
<div class="line"><span class="lineno">  421</span>          istop = 6</div>
<div class="line"><span class="lineno">  422</span>          <span class="keywordflow">go to</span> 900</div>
<div class="line"><span class="lineno">  423</span><span class="keywordflow">       end if</span></div>
<div class="line"><span class="lineno">  424</span>       arnorml = sqrt(s);</div>
<div class="line"><span class="lineno">  425</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  426</span>       <span class="keyword">call </span>aprod ( n, y, w )</div>
<div class="line"><span class="lineno">  427</span>       arnorml = sqrt( dot_product(w,w) )</div>
<div class="line"><span class="lineno">  428</span><span class="keywordflow">    end if</span></div>
<div class="line"><span class="lineno">  429</span> </div>
<div class="line"><span class="lineno">  430</span>    <span class="comment">!-------------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  431</span>    <span class="comment">! Initialize other quantities.</span></div>
<div class="line"><span class="lineno">  432</span>    <span class="comment">!-------------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  433</span>    oldb   = zero</div>
<div class="line"><span class="lineno">  434</span>    beta   = beta1</div>
<div class="line"><span class="lineno">  435</span>    dbar   = zero</div>
<div class="line"><span class="lineno">  436</span>    epsln  = zero</div>
<div class="line"><span class="lineno">  437</span>    qrnorm = beta1</div>
<div class="line"><span class="lineno">  438</span>    phibar = beta1</div>
<div class="line"><span class="lineno">  439</span>    rhs1   = beta1</div>
<div class="line"><span class="lineno">  440</span>    rhs2   = zero</div>
<div class="line"><span class="lineno">  441</span>    tnorm2 = zero</div>
<div class="line"><span class="lineno">  442</span>    ynorm2 = zero</div>
<div class="line"><span class="lineno">  443</span>    cs     = - one</div>
<div class="line"><span class="lineno">  444</span>    sn     = zero</div>
<div class="line"><span class="lineno">  445</span>    w(1:n) = zero</div>
<div class="line"><span class="lineno">  446</span>    w2(1:n)= zero</div>
<div class="line"><span class="lineno">  447</span>    r2(1:n)= r1</div>
<div class="line"><span class="lineno">  448</span> </div>
<div class="line"><span class="lineno">  449</span>    <span class="keywordflow">if</span> (debug) <span class="keywordflow">then</span></div>
<div class="line"><span class="lineno">  450</span>       <span class="keyword">write</span>(*,*) <span class="stringliteral">&#39; &#39;</span></div>
<div class="line"><span class="lineno">  451</span>       <span class="keyword">write</span>(*,*) <span class="stringliteral">&#39;b    &#39;</span>, b</div>
<div class="line"><span class="lineno">  452</span>       <span class="keyword">write</span>(*,*) <span class="stringliteral">&#39;beta &#39;</span>, beta</div>
<div class="line"><span class="lineno">  453</span>       <span class="keyword">write</span>(*,*) <span class="stringliteral">&#39; &#39;</span></div>
<div class="line"><span class="lineno">  454</span><span class="keywordflow">    end if</span></div>
<div class="line"><span class="lineno">  455</span> </div>
<div class="line"><span class="lineno">  456</span>    <span class="comment">!===================================================================</span></div>
<div class="line"><span class="lineno">  457</span>    <span class="comment">! Main iteration loop.</span></div>
<div class="line"><span class="lineno">  458</span>    <span class="comment">!===================================================================</span></div>
<div class="line"><span class="lineno">  459</span>    <span class="keywordflow">do</span></div>
<div class="line"><span class="lineno">  460</span>       itn = itn + 1               <span class="comment">! k = itn = 1 first time through</span></div>
<div class="line"><span class="lineno">  461</span> </div>
<div class="line"><span class="lineno">  462</span>       <span class="comment">!----------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  463</span>       <span class="comment">! Obtain quantities for the next Lanczos vector vk+1, k = 1, 2,...</span></div>
<div class="line"><span class="lineno">  464</span>       <span class="comment">! The general iteration is similar to the case k = 1 with v0 = 0:</span></div>
<div class="line"><span class="lineno">  465</span>       <span class="comment">!</span></div>
<div class="line"><span class="lineno">  466</span>       <span class="comment">!   p1      = Operator * v1  -  beta1 * v0,</span></div>
<div class="line"><span class="lineno">  467</span>       <span class="comment">!   alpha1  = v1&#39;p1,</span></div>
<div class="line"><span class="lineno">  468</span>       <span class="comment">!   q2      = p2  -  alpha1 * v1,</span></div>
<div class="line"><span class="lineno">  469</span>       <span class="comment">!   beta2^2 = q2&#39;q2,</span></div>
<div class="line"><span class="lineno">  470</span>       <span class="comment">!   v2      = (1/beta2) q2.</span></div>
<div class="line"><span class="lineno">  471</span>       <span class="comment">!</span></div>
<div class="line"><span class="lineno">  472</span>       <span class="comment">! Again, y = betak P vk,  where  P = C**(-1).</span></div>
<div class="line"><span class="lineno">  473</span>       <span class="comment">! .... more description needed.</span></div>
<div class="line"><span class="lineno">  474</span>       <span class="comment">!----------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  475</span>       s      = one / beta            <span class="comment">! Normalize previous vector (in y).</span></div>
<div class="line"><span class="lineno">  476</span>       v      = s*y(1:n)              <span class="comment">! v = vk if P = I</span></div>
<div class="line"><span class="lineno">  477</span> </div>
<div class="line"><span class="lineno">  478</span>       <span class="keyword">call </span>aprod ( n, v, y )</div>
<div class="line"><span class="lineno">  479</span>       y      = y - shift*v           <span class="comment">! call daxpy ( n, (- shift), v, 1, y, 1 )</span></div>
<div class="line"><span class="lineno">  480</span>       <span class="keywordflow">if</span> (itn &gt;= 2) <span class="keywordflow">then</span></div>
<div class="line"><span class="lineno">  481</span>          y   = y - (beta/oldb)*r1    <span class="comment">! call daxpy ( n, (- beta/oldb), r1, 1, y, 1 )</span></div>
<div class="line"><span class="lineno">  482</span><span class="keywordflow">       end if</span></div>
<div class="line"><span class="lineno">  483</span> </div>
<div class="line"><span class="lineno">  484</span>       alfa   = dot_product(v,y)      <span class="comment">! alphak</span></div>
<div class="line"><span class="lineno">  485</span>       y      = y - (alfa/beta)*r2    <span class="comment">! call daxpy ( n, (- alfa/beta), r2, 1, y, 1 )</span></div>
<div class="line"><span class="lineno">  486</span>       r1     = r2</div>
<div class="line"><span class="lineno">  487</span>       r2     = y</div>
<div class="line"><span class="lineno">  488</span>       <span class="keywordflow">if</span> ( <a class="code hl_function" href="mpnum_8f90.html#a1be727b806123cdbd7ae0695df918243">precon</a> ) <span class="keyword">call </span>msolve( n, r2, y )</div>
<div class="line"><span class="lineno">  489</span> </div>
<div class="line"><span class="lineno">  490</span>       oldb   = beta                  <span class="comment">! oldb = betak</span></div>
<div class="line"><span class="lineno">  491</span>       beta   = dot_product(r2,y)     <span class="comment">! beta = betak+1^2</span></div>
<div class="line"><span class="lineno">  492</span>       <span class="keywordflow">if</span> (beta &lt; zero) <span class="keywordflow">then</span></div>
<div class="line"><span class="lineno">  493</span>          istop = 6</div>
<div class="line"><span class="lineno">  494</span>          <span class="keywordflow">go to</span> 900</div>
<div class="line"><span class="lineno">  495</span><span class="keywordflow">       end if</span></div>
<div class="line"><span class="lineno">  496</span> </div>
<div class="line"><span class="lineno">  497</span>       beta   = sqrt( beta )          <span class="comment">! beta = betak+1</span></div>
<div class="line"><span class="lineno">  498</span>       tnorm2 = tnorm2 + alfa**2 + oldb**2 + beta**2</div>
<div class="line"><span class="lineno">  499</span> </div>
<div class="line"><span class="lineno">  500</span>       <span class="keywordflow">if</span> (itn == 1) <span class="keywordflow">then</span>                   <span class="comment">! Initialize a few things.</span></div>
<div class="line"><span class="lineno">  501</span>          <span class="keywordflow">if</span> (beta/beta1 &lt;= ten*eps) <span class="keywordflow">then</span>   <span class="comment">! beta2 = 0 or ~ 0.</span></div>
<div class="line"><span class="lineno">  502</span>             istop = -1                     <span class="comment">! Terminate later.</span></div>
<div class="line"><span class="lineno">  503</span><span class="keywordflow">          end if</span></div>
<div class="line"><span class="lineno">  504</span>         <span class="comment">!tnorm2 = alfa**2</span></div>
<div class="line"><span class="lineno">  505</span>          gmax   = abs( alfa )              <span class="comment">! alpha1</span></div>
<div class="line"><span class="lineno">  506</span>          gmin   = gmax                     <span class="comment">! alpha1</span></div>
<div class="line"><span class="lineno">  507</span><span class="keywordflow">       end if</span></div>
<div class="line"><span class="lineno">  508</span> </div>
<div class="line"><span class="lineno">  509</span>       <span class="comment">! Apply previous rotation Qk-1 to get</span></div>
<div class="line"><span class="lineno">  510</span>       <span class="comment">!   [deltak epslnk+1] = [cs  sn][dbark    0   ]</span></div>
<div class="line"><span class="lineno">  511</span>       <span class="comment">!   [gbar k dbar k+1]   [sn -cs][alfak betak+1].</span></div>
<div class="line"><span class="lineno">  512</span> </div>
<div class="line"><span class="lineno">  513</span>       oldeps = epsln</div>
<div class="line"><span class="lineno">  514</span>       delta  = cs * dbar  +  sn * alfa <span class="comment">! delta1 = 0         deltak</span></div>
<div class="line"><span class="lineno">  515</span>       gbar   = sn * dbar  -  cs * alfa <span class="comment">! gbar 1 = alfa1     gbar k</span></div>
<div class="line"><span class="lineno">  516</span>       epsln  =               sn * beta <span class="comment">! epsln2 = 0         epslnk+1</span></div>
<div class="line"><span class="lineno">  517</span>       dbar   =            -  cs * beta <span class="comment">! dbar 2 = beta2     dbar k+1</span></div>
<div class="line"><span class="lineno">  518</span> </div>
<div class="line"><span class="lineno">  519</span>       <span class="comment">! Compute the next plane rotation Qk</span></div>
<div class="line"><span class="lineno">  520</span> </div>
<div class="line"><span class="lineno">  521</span>       gamma  = sqrt( gbar**2 + beta**2 )   <span class="comment">! gammak</span></div>
<div class="line"><span class="lineno">  522</span>       cs     = gbar / gamma                <span class="comment">! ck</span></div>
<div class="line"><span class="lineno">  523</span>       sn     = beta / gamma                <span class="comment">! sk</span></div>
<div class="line"><span class="lineno">  524</span>       phi    = cs * phibar                 <span class="comment">! phik</span></div>
<div class="line"><span class="lineno">  525</span>       phibar = sn * phibar                 <span class="comment">! phibark+1</span></div>
<div class="line"><span class="lineno">  526</span> </div>
<div class="line"><span class="lineno">  527</span>       <span class="keywordflow">if</span> (debug) <span class="keywordflow">then</span></div>
<div class="line"><span class="lineno">  528</span>          <span class="keyword">write</span>(*,*) <span class="stringliteral">&#39; &#39;</span></div>
<div class="line"><span class="lineno">  529</span>          <span class="keyword">write</span>(*,*) <span class="stringliteral">&#39;v    &#39;</span>, v</div>
<div class="line"><span class="lineno">  530</span>          <span class="keyword">write</span>(*,*) <span class="stringliteral">&#39;alfa &#39;</span>, alfa</div>
<div class="line"><span class="lineno">  531</span>          <span class="keyword">write</span>(*,*) <span class="stringliteral">&#39;beta &#39;</span>, beta</div>
<div class="line"><span class="lineno">  532</span>          <span class="keyword">write</span>(*,*) <span class="stringliteral">&#39;gamma&#39;</span>, gamma</div>
<div class="line"><span class="lineno">  533</span>          <span class="keyword">write</span>(*,*) <span class="stringliteral">&#39;delta&#39;</span>, delta</div>
<div class="line"><span class="lineno">  534</span>          <span class="keyword">write</span>(*,*) <span class="stringliteral">&#39;gbar &#39;</span>, gbar</div>
<div class="line"><span class="lineno">  535</span>          <span class="keyword">write</span>(*,*) <span class="stringliteral">&#39;epsln&#39;</span>, epsln</div>
<div class="line"><span class="lineno">  536</span>          <span class="keyword">write</span>(*,*) <span class="stringliteral">&#39;dbar &#39;</span>, dbar</div>
<div class="line"><span class="lineno">  537</span>          <span class="keyword">write</span>(*,*) <span class="stringliteral">&#39;phi  &#39;</span>, phi</div>
<div class="line"><span class="lineno">  538</span>          <span class="keyword">write</span>(*,*) <span class="stringliteral">&#39;phiba&#39;</span>, phibar</div>
<div class="line"><span class="lineno">  539</span>          <span class="keyword">write</span>(*,*) <span class="stringliteral">&#39; &#39;</span></div>
<div class="line"><span class="lineno">  540</span><span class="keywordflow">       end if</span></div>
<div class="line"><span class="lineno">  541</span> </div>
<div class="line"><span class="lineno">  542</span>       <span class="comment">! Update  x.</span></div>
<div class="line"><span class="lineno">  543</span> </div>
<div class="line"><span class="lineno">  544</span>       denom = one/gamma</div>
<div class="line"><span class="lineno">  545</span> </div>
<div class="line"><span class="lineno">  546</span>       <span class="keywordflow">do</span> i = 1, n</div>
<div class="line"><span class="lineno">  547</span>          w1(i) = w2(i)</div>
<div class="line"><span class="lineno">  548</span>          w2(i) = w(i)</div>
<div class="line"><span class="lineno">  549</span>          w(i)  = ( v(i) - oldeps*w1(i) - delta*w2(i) ) * denom</div>
<div class="line"><span class="lineno">  550</span>          x(i)  =   x(i) +   phi * w(i)</div>
<div class="line"><span class="lineno">  551</span><span class="keywordflow">       end do</span></div>
<div class="line"><span class="lineno">  552</span> </div>
<div class="line"><span class="lineno">  553</span>       <span class="comment">! Go round again.</span></div>
<div class="line"><span class="lineno">  554</span> </div>
<div class="line"><span class="lineno">  555</span>       gmax   = max( gmax, gamma )</div>
<div class="line"><span class="lineno">  556</span>       gmin   = min( gmin, gamma )</div>
<div class="line"><span class="lineno">  557</span>       z      = rhs1 / gamma</div>
<div class="line"><span class="lineno">  558</span>       ynorm2 = z**2  +  ynorm2</div>
<div class="line"><span class="lineno">  559</span>       rhs1   = rhs2  -  delta * z</div>
<div class="line"><span class="lineno">  560</span>       rhs2   =       -  epsln * z</div>
<div class="line"><span class="lineno">  561</span> </div>
<div class="line"><span class="lineno">  562</span>       <span class="comment">! Estimate various norms and test for convergence.</span></div>
<div class="line"><span class="lineno">  563</span> </div>
<div class="line"><span class="lineno">  564</span>       anorm  = sqrt( tnorm2 )</div>
<div class="line"><span class="lineno">  565</span>       ynorm  = sqrt( ynorm2 )</div>
<div class="line"><span class="lineno">  566</span>       epsa   = anorm * eps</div>
<div class="line"><span class="lineno">  567</span>       epsx   = anorm * ynorm * eps</div>
<div class="line"><span class="lineno">  568</span>       epsr   = anorm * ynorm * rtol</div>
<div class="line"><span class="lineno">  569</span>       diag   = gbar</div>
<div class="line"><span class="lineno">  570</span>       <span class="keywordflow">if</span> (diag == zero) diag = epsa</div>
<div class="line"><span class="lineno">  571</span> </div>
<div class="line"><span class="lineno">  572</span>       qrnorm = phibar</div>
<div class="line"><span class="lineno">  573</span>       rnorml = rnorm</div>
<div class="line"><span class="lineno">  574</span>       rnorm  = qrnorm</div>
<div class="line"><span class="lineno">  575</span>       rootl       = sqrt( gbar**2 +dbar**2  )  <span class="comment">! norm([gbar; dbar]);</span></div>
<div class="line"><span class="lineno">  576</span>       arnorml     = rnorml*rootl               <span class="comment">! ||A r_{k-1} ||</span></div>
<div class="line"><span class="lineno">  577</span>       relarnorml  = rootl  /  anorm;           <span class="comment">! ||Ar|| / (||A|| ||r||)     </span></div>
<div class="line"><span class="lineno">  578</span>       <span class="comment">!relArnorml = Arnorml / Anorm;           ! ||Ar|| / ||A|| </span></div>
<div class="line"><span class="lineno">  579</span> </div>
<div class="line"><span class="lineno">  580</span>       <span class="comment">! Estimate  cond(A).</span></div>
<div class="line"><span class="lineno">  581</span>       <span class="comment">! In this version we look at the diagonals of  R  in the</span></div>
<div class="line"><span class="lineno">  582</span>       <span class="comment">! factorization of the lower Hessenberg matrix,  Q * H = R,</span></div>
<div class="line"><span class="lineno">  583</span>       <span class="comment">! where H is the tridiagonal matrix from Lanczos with one</span></div>
<div class="line"><span class="lineno">  584</span>       <span class="comment">! extra row, beta(k+1) e_k^T.</span></div>
<div class="line"><span class="lineno">  585</span> </div>
<div class="line"><span class="lineno">  586</span>       acond  = gmax / gmin</div>
<div class="line"><span class="lineno">  587</span> </div>
<div class="line"><span class="lineno">  588</span>       <span class="comment">! See if any of the stopping criteria are satisfied.</span></div>
<div class="line"><span class="lineno">  589</span>       <span class="comment">! In rare cases, istop is already -1 from above (Abar = const*I).</span></div>
<div class="line"><span class="lineno">  590</span> </div>
<div class="line"><span class="lineno">  591</span>       <span class="keywordflow">if</span> (istop == 0) <span class="keywordflow">then</span></div>
<div class="line"><span class="lineno">  592</span>          <span class="keywordflow">if</span> (itn    &gt;= itnlim    ) istop = 5</div>
<div class="line"><span class="lineno">  593</span>          <span class="keywordflow">if</span> (acond  &gt;= 0.1d+0/eps) istop = 4</div>
<div class="line"><span class="lineno">  594</span>          <span class="keywordflow">if</span> (epsx   &gt;= beta1     ) istop = 3</div>
<div class="line"><span class="lineno">  595</span>          <span class="comment">! original</span></div>
<div class="line"><span class="lineno">  596</span>          <span class="comment">!if (qrnorm &lt;= epsx  .or.  relArnorml &lt;= epsx) istop = 2</span></div>
<div class="line"><span class="lineno">  597</span>          <span class="comment">!if (qrnorm &lt;= epsr  .or.  relArnorml &lt;= epsr) istop = 1</span></div>
<div class="line"><span class="lineno">  598</span>          <span class="comment">! C. Kleinwort, DESY, 131002</span></div>
<div class="line"><span class="lineno">  599</span>          <span class="keywordflow">if</span> (qrnorm &lt;= epsx  .or.  relarnorml &lt;= eps) istop = 2</div>
<div class="line"><span class="lineno">  600</span>          <span class="keywordflow">if</span> (qrnorm &lt;= epsr  .or.  relarnorml &lt;= rtol) istop = 1</div>
<div class="line"><span class="lineno">  601</span><span class="keywordflow">       end if</span></div>
<div class="line"><span class="lineno">  602</span> </div>
<div class="line"><span class="lineno">  603</span> </div>
<div class="line"><span class="lineno">  604</span>       <span class="comment">! See if it is time to print something.</span></div>
<div class="line"><span class="lineno">  605</span> </div>
<div class="line"><span class="lineno">  606</span>       <span class="keywordflow">if</span> (nout &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><span class="lineno">  607</span>          prnt   = .false.</div>
<div class="line"><span class="lineno">  608</span>          <span class="keywordflow">if</span> (n      &lt;= 40         ) prnt = .true.</div>
<div class="line"><span class="lineno">  609</span>          <span class="keywordflow">if</span> (itn    &lt;= 10         ) prnt = .true.</div>
<div class="line"><span class="lineno">  610</span>          <span class="keywordflow">if</span> (itn    &gt;= itnlim - 10) prnt = .true.</div>
<div class="line"><span class="lineno">  611</span>          <span class="keywordflow">if</span> (mod(itn,10)  ==     0) prnt = .true.</div>
<div class="line"><span class="lineno">  612</span>          <span class="keywordflow">if</span> (qrnorm &lt;=  ten * epsx) prnt = .true.</div>
<div class="line"><span class="lineno">  613</span>          <span class="keywordflow">if</span> (qrnorm &lt;=  ten * epsr) prnt = .true.</div>
<div class="line"><span class="lineno">  614</span>          <span class="keywordflow">if</span> (relarnorml&lt;= ten*epsx) prnt = .true.</div>
<div class="line"><span class="lineno">  615</span>          <span class="keywordflow">if</span> (relarnorml&lt;= ten*epsr) prnt = .true.</div>
<div class="line"><span class="lineno">  616</span>          <span class="keywordflow">if</span> (acond  &gt;= 1.0d-2/eps ) prnt = .true.</div>
<div class="line"><span class="lineno">  617</span>          <span class="keywordflow">if</span> (istop  /=  0         ) prnt = .true.</div>
<div class="line"><span class="lineno">  618</span> </div>
<div class="line"><span class="lineno">  619</span>          <span class="keywordflow">if</span> ( prnt ) <span class="keywordflow">then</span></div>
<div class="line"><span class="lineno">  620</span>             <span class="keywordflow">if</span> (    itn     == 1) <span class="keyword">write</span>(nout, 1200)</div>
<div class="line"><span class="lineno">  621</span>             <span class="keyword">write</span>(nout, 1300) itn, x(1), qrnorm, anorm, acond</div>
<div class="line"><span class="lineno">  622</span>             <span class="keywordflow">if</span> (mod(itn,10) == 0) <span class="keyword">write</span>(nout, 1500)</div>
<div class="line"><span class="lineno">  623</span><span class="keywordflow">          end if</span></div>
<div class="line"><span class="lineno">  624</span><span class="keywordflow">       end if</span></div>
<div class="line"><span class="lineno">  625</span>       <span class="keywordflow">if</span> (istop /= 0) <span class="keywordflow">exit</span></div>
<div class="line"><span class="lineno">  626</span> </div>
<div class="line"><span class="lineno">  627</span><span class="keywordflow">    end do</span></div>
<div class="line"><span class="lineno">  628</span>    <span class="comment">!===================================================================</span></div>
<div class="line"><span class="lineno">  629</span>    <span class="comment">! End of iteration loop.</span></div>
<div class="line"><span class="lineno">  630</span>    <span class="comment">!===================================================================</span></div>
<div class="line"><span class="lineno">  631</span> </div>
<div class="line"><span class="lineno">  632</span>    <span class="comment">! Display final status.</span></div>
<div class="line"><span class="lineno">  633</span> </div>
<div class="line"><span class="lineno">  634</span>900 arnorm = arnorml</div>
<div class="line"><span class="lineno">  635</span>    <span class="keywordflow">if</span> (nout  &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><span class="lineno">  636</span>       <span class="keyword">write</span>(nout, 2000) exitt, istop, itn,   &amp;</div>
<div class="line"><span class="lineno">  637</span>                         exitt, anorm, acond, &amp;</div>
<div class="line"><span class="lineno">  638</span>                         exitt, rnorm, ynorm, arnorm</div>
<div class="line"><span class="lineno">  639</span>       <span class="keyword">write</span>(nout, 3000) exitt, msg(istop)</div>
<div class="line"><span class="lineno">  640</span><span class="keywordflow">    end if</span></div>
<div class="line"><span class="lineno">  641</span> </div>
<div class="line"><span class="lineno">  642</span>    <span class="keywordflow">return</span></div>
<div class="line"><span class="lineno">  643</span> </div>
<div class="line"><span class="lineno">  644</span> 1000 <span class="keyword">format</span>(// 1p,    a, 5x, <span class="stringliteral">&#39;Solution of symmetric   Ax = b&#39;</span>    &amp;</div>
<div class="line"><span class="lineno">  645</span>              / <span class="stringliteral">&#39; n      =&#39;</span>, i7, 5x, <span class="stringliteral">&#39;checkA =&#39;</span>, l4, 12x,         &amp;</div>
<div class="line"><span class="lineno">  646</span>                 <span class="stringliteral">&#39;precon =&#39;</span>, l4                                   &amp;</div>
<div class="line"><span class="lineno">  647</span>              / <span class="stringliteral">&#39; itnlim =&#39;</span>, i7, 5x, <span class="stringliteral">&#39;rtol   =&#39;</span>, e11.2, 5x,       &amp;</div>
<div class="line"><span class="lineno">  648</span>                 <span class="stringliteral">&#39;shift  =&#39;</span>, e23.14)</div>
<div class="line"><span class="lineno">  649</span> 1200 <span class="keyword">format</span>(// 5x, <span class="stringliteral">&#39;itn&#39;</span>, 8x, <span class="stringliteral">&#39;x(1)&#39;</span>, 10x,                       &amp;</div>
<div class="line"><span class="lineno">  650</span>                <span class="stringliteral">&#39;norm(r)&#39;</span>, 3x, <span class="stringliteral">&#39;norm(A)&#39;</span>, 3x, <span class="stringliteral">&#39;cond(A)&#39;</span>)</div>
<div class="line"><span class="lineno">  651</span> 1300 <span class="keyword">format</span>(1p, i8, e19.10, 3e10.2)</div>
<div class="line"><span class="lineno">  652</span> 1500 <span class="keyword">format</span>(1x)</div>
<div class="line"><span class="lineno">  653</span> 2000 <span class="keyword">format</span>(/ 1p, a, 5x, <span class="stringliteral">&#39;istop =&#39;</span>, i3,   14x, <span class="stringliteral">&#39;itn   =&#39;</span>, i8     &amp;</div>
<div class="line"><span class="lineno">  654</span>             /     a, 5x, <span class="stringliteral">&#39;Anorm =&#39;</span>, e12.4, 5x, <span class="stringliteral">&#39;Acond =&#39;</span>, e12.4  &amp;</div>
<div class="line"><span class="lineno">  655</span>             /     a, 5x, <span class="stringliteral">&#39;rnorm =&#39;</span>, e12.4, 5x, <span class="stringliteral">&#39;ynorm =&#39;</span>, e12.4, 5x, <span class="stringliteral">&#39;Arnorml =&#39;</span>, e12.4)</div>
<div class="line"><span class="lineno">  656</span> 3000 <span class="keyword">format</span>(      a, 5x, a )</div>
<div class="line"><span class="lineno">  657</span> </div>
<div class="ttc" id="ampnum_8f90_html_a1be727b806123cdbd7ae0695df918243"><div class="ttname"><a href="mpnum_8f90.html#a1be727b806123cdbd7ae0695df918243">precon</a></div><div class="ttdeci">subroutine precon(p, n, c, cu, a, s, nrkd)</div><div class="ttdoc">Constrained preconditioner, decomposition.</div><div class="ttdef"><b>Definition</b> <a href="mpnum_8f90_source.html#l02171">mpnum.f90:2172</a></div></div>
<div class="ttc" id="anamespaceminresdatamodule_html"><div class="ttname"><a href="namespaceminresdatamodule.html">minresdatamodule</a></div><div class="ttdoc">Defines real(kind=dp) and a few constants for use in other modules.</div><div class="ttdef"><b>Definition</b> <a href="minresDataModule_8f90_source.html#l00019">minresDataModule.f90:19</a></div></div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespaceminresmodule.html">minresmodule</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
