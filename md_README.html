<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SND@LHC Software: sndsw</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">SND@LHC Software
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_README.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">sndsw</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><b>Table of Contents</b></p>
<ul>
<li>Introduction<ul>
<li>Contact and communication</li>
<li>Branches</li>
</ul>
</li>
<li>Build instructions<ul>
<li>Introduction to `aliBuild`</li>
<li>On lxplus or systems with CVMFS</li>
<li>On systems without access to CVMFS</li>
</ul>
</li>
<li>Run instructions<ul>
<li>Use cases covered by `run_simSND.py`</li>
<li>Digitization of MC data</li>
<li>Converting raw data to sndsw format</li>
<li>Example scripts for accessing the raw data and making histograms</li>
<li>simple 2d event display with Scifi tracking</li>
</ul>
</li>
<li>Development<ul>
<li>How to keep branches up to date</li>
<li>How to contribute code</li>
</ul>
</li>
<li>Docker Instructions</li>
</ul>
<h1><a class="anchor" id="autotoc_md21"></a>
Introduction</h1>
<p><code>sndsw</code> is the software framework of the SND@LHC collaboration. It is based on the <a href="https://github.com/ShipSoft/FairShip">FairShip</a> framework developed by the SHiP collaboration which in turn is based on <a href="https://github.com/FairRootGroup/FairRoot/">FairRoot</a>, making use of the automatic python bindings provided by PyROOT.</p>
<h2><a class="anchor" id="autotoc_md22"></a>
Contact and communication</h2>
<p>If you have questions or problems, please feel free to contact the @SND-LHC/core-developers. For troubleshooting and development, we plan to discuss on <a href="https://mattermost.web.cern.ch/sndlhc-daq/channels/software-and-analysis">Mattermost</a>.</p>
<p>The <a href="#" onclick="location.href='mai'+'lto:'+'snd'+'-s'+'oft'+'wa'+'re@'+'ce'+'rn.'+'ch'; return false;">snd-software</a> mailing list can be used to discuss the software and report issues. Important annoucements will be made there.</p>
<p>The <a href="#" onclick="location.href='mai'+'lto:'+'snd'+'-s'+'oft'+'wa'+'re-'+'no'+'tif'+'ic'+'ati'+'on'+'s@c'+'er'+'n.c'+'h'; return false;">snd-software-notifications</a> mailing list will be used for automated notifications from Github and CI/CD etc..</p>
<p>Both mailing lists are self-subscribe CERN e-groups.</p>
<h2><a class="anchor" id="autotoc_md23"></a>
Branches</h2>
<dl>
<dt><code>master</code> </dt>
<dd>Main development branch. All python code is <b>required to be compatible with 3</b> Requires aliBuild default <code>release</code>. </dd>
</dl>
<h1><a class="anchor" id="autotoc_md24"></a>
Build instructions</h1>
<p>The <code>aliBuild</code> family of tools developed by ALICE is used to set up <code>sndsw</code> and its dependencies.</p>
<h2><a class="anchor" id="autotoc_md25"></a>
Introduction to &lt;tt&gt;aliBuild&lt;/tt&gt;</h2>
<p>The basic commands are the same regardless of whether CVMFS is used:</p>
<dl>
<dt><code>aliBuild build &lt;package-name&gt; -c snddist</code> </dt>
<dd>Build the package <code>&lt;package-name&gt;</code> (e.g. <code>sndsw</code>) and its dependencies using the recipes and configuration provided by snddist. On CVMFS, it is recommended to add <code>&ndash;always-prefer-system</code> to ensure packages are used from CVMFS instead of being rebuilt. </dd>
<dt><code>aliDoctor &lt;package-name&gt; -c snddist</code> </dt>
<dd>Provide troubleshooting information and hints on which packages can be used from the system for <code>&lt;package-name&gt;</code> and its dependencies. </dd>
<dt><code>alienv enter &lt;package-name&gt; /latest -c snddist</code> </dt>
<dd>Enter an environment with <code>&lt;package-name&gt;</code> and its dependencies. </dd>
</dl>
<p>For more information on using <code>aliBuild</code>, see its <a href="https://alisw.github.io/alibuild/">documentation</a> (note: some things are ALICE specific and will not apply to SND@LHC software).</p>
<h2><a class="anchor" id="autotoc_md26"></a>
On lxplus or systems with CVMFS</h2>
<p>On <code>lxplus</code> or supported platforms with access to CVMFS, you can do the following:</p>
<ol type="1">
<li>Make sure you can access the SNDLHC CVMFS Repository <div class="fragment"><div class="line">ls /cvmfs/sndlhc.cern.ch</div>
</div><!-- fragment --> Check if your platform is supported for the given release in production. The latest release is the recommended one. <div class="fragment"><div class="line">cat /cvmfs/sndlhc.cern.ch/README</div>
</div><!-- fragment --></li>
<li>Source the <code>setUp.sh</code> script <div class="fragment"><div class="line">source /cvmfs/sndlhc.cern.ch/SNDLHC-2025/Jan30/setUp.sh  # recommended latest version</div>
</div><!-- fragment --></li>
<li>If you don't want to modify the sndsw package, skip step 3: <div class="fragment"><div class="line">git clone https://github.com/SND-LHC/sndsw</div>
</div><!-- fragment --> This gives you by default the master branch of the software. In case, you want to use a specific branch: <div class="fragment"><div class="line">cd sndsw</div>
<div class="line">git checkout &lt;branch&gt;</div>
<div class="line">cd ..</div>
</div><!-- fragment --></li>
<li>Build the software using <code>aliBuild</code> <div class="fragment"><div class="line">aliBuild build sndsw -c $SNDDIST --always-prefer-system --default release</div>
</div><!-- fragment --> If you exit your shell session and you want to go back working on it, make sure to re-execute the second step.</li>
</ol>
<p>To load the <code>sndsw</code> environment, after you build the software, you can simply use:</p>
<ol type="1">
<li>Load the environment <div class="fragment"><div class="line">alienv enter sndsw/latest</div>
</div><!-- fragment --></li>
</ol>
<p>However, this won't work if you are using HTCondor. In such case you can do:</p>
<div class="fragment"><div class="line">eval $(alienv load sndsw/latest --no-refresh)</div>
</div><!-- fragment --><p>If you modify <code>sndsw</code>, simply repeat step 4 from <code>sndsw</code>'s parent directory.</p>
<h2><a class="anchor" id="autotoc_md27"></a>
On systems without access to CVMFS</h2>
<p>Commands are similar to the previous case, but without access to CVMFS you need to build the required packages from source.</p>
<ol type="1">
<li>Clone the <a href="https://github.com/SND-LHC/snddist">snddist</a>, which containts the recipes to build <code>sndsw</code> and it's dependencies: <div class="fragment"><div class="line">git clone https://github.com/SND-LHC/snddist.git</div>
</div><!-- fragment --></li>
<li>If you don't want to modify the sndsw package, skip step 2: <div class="fragment"><div class="line">git clone https://github.com/SND-LHC/sndsw</div>
</div><!-- fragment --> This gives you by default the master branch of the software. In case, you want to use a specific branch: <div class="fragment"><div class="line">cd sndsw</div>
<div class="line">git checkout &lt;branch&gt;</div>
<div class="line">cd ..</div>
</div><!-- fragment --></li>
<li>Install <a href="https://github.com/alisw/alibuild">aliBuild</a> <div class="fragment"><div class="line">bash</div>
<div class="line">   pip3 install --user alibuild</div>
</div><!-- fragment --> and make sure that it is in your $PATH, or if you are administrator: <div class="fragment"><div class="line">bash</div>
<div class="line">   sudo pip3 install alibuild</div>
</div><!-- fragment --></li>
<li>Build the software using aliBuild <div class="fragment"><div class="line">aliBuild build sndsw -c snddist --default release</div>
</div><!-- fragment --> If you run into any problems, <code>aliDoctor</code> can help determine what the problem is.</li>
<li>Load the environment <div class="fragment"><div class="line">alienv enter sndsw/latest</div>
</div><!-- fragment --></li>
</ol>
<h1><a class="anchor" id="autotoc_md28"></a>
Run instructions</h1>
<p>Set up the bulk of the environment from CVMFS.</p>
<div class="fragment"><div class="line">source /cvmfs/sndlhc.cern.ch/SNDLHC-2024/June25/setUp.sh</div>
</div><!-- fragment --><p>Load your local sndsw environment.</p>
<div class="fragment"><div class="line">alienv enter (--shellrc) sndsw/latest</div>
</div><!-- fragment --><div class="fragment"><div class="line">python $SNDSW_ROOT/shipLHC/run_simSND.py  --Ntuple  -n 100 -f /eos/experiment/sndlhc/MonteCarlo/FLUKA/muons_up/version1/unit30_Nm.root  --eMin 1.0</div>
<div class="line">&gt;&gt; Macro finished succesfully.</div>
</div><!-- fragment --> <blockquote class="doxtable">
<blockquote class="doxtable">
<p>&zwj;Output files are sndLHC.Ntuple-TGeant4.root (events) and geofile_full.Ntuple-TGeant4.root (setup) </p>
</blockquote>
</blockquote>
<p>Run the event display:</p>
<div class="fragment"><div class="line">python -i $SNDSW_ROOT/macro/eventDisplay.py -f sndLHC.Ntuple-TGeant4.root -g geofile_full.Ntuple-TGeant4.root</div>
<div class="line">// use SHiP Event Display GUI</div>
<div class="line">Use quit() or Ctrl-D (i.e. EOF) to exit</div>
</div><!-- fragment --><p> a) Use the GUI to display events: SHiP actions / next event</p>
<p>b) Hovering over trajectory will display additional information :</p>
<p>c) At python prompt: <code>sTree.MCTrack.Dump()</code> will display info about all MC particles</p>
<h2><a class="anchor" id="autotoc_md29"></a>
Use cases covered by &lt;tt&gt;run_simSND.py&lt;/tt&gt;</h2>
<ol type="1">
<li><p class="startli">Transport muons, output of FLUKA simulation, to TI18 and the detector. Positive and negative muons, up and down crossing angles, exist. Possible options are setting minimum energy for transporting particles, transport only muons, increase EM cross sections of muons.</p>
<div class="fragment"><div class="line">python $SNDSW_ROOT/shipLHC/run_simSND.py  --Ntuple  -n nEvents  -f /eos/experiment/sndlhc/MonteCarlo/FLUKA/muons_up/version1/unit30_Nm.root  --eMin ecut</div>
</div><!-- fragment --></li>
<li>Muon deep inelastic scattering events, produced with pythia6, and then positioned in TI18 and transported by Geant4: <div class="fragment"><div class="line">python  $SNDSW_ROOT/shipLHC/run_simSND.py  -F --MuDIS -n nEvents -f  /eos/experiment/sndlhc/MonteCarlo/Pythia6/MuonDIS/muonDis_1001.root  --eMin ecut</div>
</div><!-- fragment --></li>
<li>Neutrino events, produced by GENIE and then positioned in TI18 and transported by Geant4: <div class="fragment"><div class="line">python  $SNDSW_ROOT/shipLHC/run_simSND.py  --Genie -n nEvents -f ...</div>
</div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="autotoc_md30"></a>
Digitization of MC data</h2>
<ol type="1">
<li><p class="startli">Convert MC points to detector hits. Input required, data from simulation together with the geometry file created when running simulation. New objects created are <code>Digi_ScifiHits</code> together with <code>Cluster_Scifi</code> and <code>Digi_MuFilterHit</code>, and in parallel objects to make the link to the original MC points, <code>Digi_MuFilterHits2MCPoints</code> and <code>Digi_ScifiHits2MCPoints</code>.</p>
<div class="fragment"><div class="line">python $SNDSW_ROOT/shipLHC/run_digiSND.py   -f sndLHC.Ntuple-TGeant4.root -g geofile_full.Ntuple-TGeant4.root</div>
</div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="autotoc_md31"></a>
Converting raw data to sndsw format</h2>
<ol type="1">
<li><p class="startli">Runs the calibration procedure and creates <code>Digi_ScifiHits</code> and <code>Digi_MuFilterHit</code> with signal and time information from SiPM channels.</p>
<div class="fragment"><div class="line">python $SNDSW_ROOT/shipLHC/rawData/convertRawData.py -p /eos/experiment/sndlhc/testbeam/scifi-cosmic/ -r 35</div>
</div><!-- fragment --></li>
<li><p class="startli">For the <a class="el" href="classMuFilter.html">MuFilter</a> testbeam in H8, a specialized script needs to be used to also synchronize the readout boards.</p>
<div class="fragment"><div class="line">python $SNDSW_ROOT/shipLHC/rawData/convertRawData_convertRawData_muTestbeam.py -p /eos/experiment/sndlhc/testbeam/MuFilter/TB_data_commissioning/ -n 5000000  -r 91</div>
</div><!-- fragment --> </li>
</ol>
<h2><a class="anchor" id="autotoc_md32"></a>
Example scripts for accessing the raw data and making histograms</h2>
<ol type="1">
<li>For scifi data: <div class="fragment"><div class="line">python $SNDSW_ROOT/shipLHC/rawData/scifiHitMaps.py -p /eos/experiment/sndlhc/testbeam/scifi/sndsw/ -r 1 -g geofile_full.Ntuple-TGeant4.root</div>
</div><!-- fragment --></li>
<li>For MuFi data: <div class="fragment"><div class="line">python $SNDSW_ROOT/shipLHC/rawData/mufiHitMaps.py -p /eos/experiment/sndlhc/testbeam/MuFilter/TB_data_commissioning/sndsw/ -r 90 -g geofile_full.Ntuple-TGeant4.root</div>
</div><!-- fragment --> Two methods implemented, hitMaps(Nev = -1) and eventTime().</li>
</ol>
<h2><a class="anchor" id="autotoc_md33"></a>
simple 2d event display with Scifi tracking</h2>
<ol type="1">
<li>Use method loopEvents(start=0,save=False,goodEvents=False,withTrack=False) <div class="fragment"><div class="line">python $SNDSW_ROOT/shipLHC/scripts/scifiHitMaps.py -p /eos/experiment/sndlhc/testbeam/scifi/sndsw/ -r 1 -g geofile_full.Ntuple-TGeant4.root</div>
</div><!-- fragment --></li>
</ol>
<h1><a class="anchor" id="autotoc_md34"></a>
Development</h1>
<p>All packages are managed in Git and GitHub. Please either use the web interface to create pull requests or issues, or <a href="https://git-send-email.io/">send patches via email</a>.</p>
<p>If your changes would also benefit <a href="https://github.com/ShipSoft/FairShip">FairShip</a>, please consider making a pull-request for your changes there. We can then pick up the changes from FairShip automatically.</p>
<h2><a class="anchor" id="autotoc_md35"></a>
How to keep branches up to date</h2>
<p>To update one's local copy of a branch with the latest modifications of that branch on the upstream repository do: </p><div class="fragment"><div class="line">cd sndsw</div>
<div class="line">git checkout &lt;branch&gt;</div>
<div class="line">git pull --rebase</div>
<div class="line">cd ..</div>
</div><!-- fragment --><p> and build the software as usual per the Build instructions.</p>
<p>While working on your local copy of a feature <code>branch</code>, it is possible that the upstream <code>master</code> software changes (e.g. because a pull request was merged into master). Then one propagates the updates of the upstream <code>master</code> to the local <code>branch</code> (<code>master -&gt; branch</code>) doing: </p><div class="fragment"><div class="line">cd sndsw</div>
<div class="line">git checkout master</div>
<div class="line">git pull --rebase</div>
<div class="line">git checkout &lt;branch&gt;</div>
<div class="line">git pull --rebase # skip this step if the branch only exists locally</div>
<div class="line">git rebase -i master</div>
<div class="line">cd ..</div>
</div><!-- fragment --><p> This will put all commits of the feature branch on top of the <code>master</code> commits. Note that before the <code>rebase</code> the local feature <code>branch</code> was updated via <code>git pull --rebase</code> too in case it changed on the upstream repository.</p>
<p>If the <code>master</code> and the local <code>branch</code> both change the same line(s) in a file(s), a <code>conflict</code> arises. Don't panic! Follow the command-line instructions to resolve them or seek help through the <a href="#" onclick="location.href='mai'+'lto:'+'snd'+'-s'+'oft'+'wa'+'re@'+'ce'+'rn.'+'ch'; return false;">snd-software</a> mailing list or the <a href="https://mattermost.web.cern.ch/sndlhc-daq/channels/software-and-analysis">Software and Analysis Mattermost channel</a>. One can verify the <code>commit history</code> reading the <code>git log</code> or inspecting via the graphical tool typing <code>gitk</code>.</p>
<p>After solving any encountered <code>conflict</code>, build the updated branch as per the Build instructions.</p>
<p>Following a <code>rebase</code> and after solving <code>conflicts</code>, to push one's local changes to the feature <code>branch</code> on the upstream repository do: </p><div class="fragment"><div class="line">git push --force-with-lease --set-upstream origin &lt;branch&gt;</div>
</div><!-- fragment --><p> Follow the link for further reading why we use <a href="https://stackoverflow.com/questions/52823692/git-push-force-with-lease-vs-force/52823955#52823955"><code>--force-with-lease</code> flag</a>.</p>
<h2><a class="anchor" id="autotoc_md36"></a>
How to contribute code</h2>
<p>Proposals for contributions to any target branch are made using <code>Pull requests</code>. Furthermore, all <code>Pull requests</code> to the <code>master</code> branch on the upstream repository go through a review process by the <code>sndsw</code> <a href="https://github.com/orgs/SND-LHC/teams/core-developers"><code>core-developers</code></a>. To make a <code>Pull request</code>, follow the guidelines below:</p>
<ol type="1">
<li>Prepare you feature <code>branch</code> and commit all your updates/fixes.</li>
<li>Update the branch and take care of potential conflicts, as described above</li>
<li>Go online to <a href="https://github.com/SND-LHC/sndsw/pulls">the sndsw Pull request webpage</a> and click on <code>New pull request</code>. Follow through the fields and verify the request goes from <code>branch</code> to the desired branch of <code>SND-LHC/sndsw</code>, i.e. <code>base:target_branch &lt;- compare:branch</code></li>
<li>Leave a message explaining your changes, the need for them, etc. For <code>Pull requests</code> to the <code>master</code> branch:</li>
<li>On the right panel, under the <code>Reviewers</code> heading one can chose who should review the code, e.g. the expert for a syb-system or topic, or someone who you have discussed the changes with. Otherwise, the default is <code>core-developers</code>.</li>
<li>Create the <code>Pull request</code>.</li>
</ol>
<h1><a class="anchor" id="autotoc_md37"></a>
Docker Instructions</h1>
<p>Docker is <b>not</b> the recommended way to run <code>sndsw</code> locally. It is ideal for reproducing reproducible, stateless environments for debugging, HTCondor and cluster use, or when a strict separation between <code>sndsw</code> and the host is desirable.</p>
<ol type="1">
<li>Build an docker image from the provided <code>Dockerfile</code>: <div class="fragment"><div class="line">git clone https://github.com/SND-LHC/sndsw.git</div>
<div class="line">cd sndsw</div>
<div class="line">docker build -t sndsw .</div>
</div><!-- fragment --></li>
<li>Run the <code>sndsw</code> docker image: <div class="fragment"><div class="line">docker run -i -t --rm sndsw /bin/bash</div>
</div><!-- fragment --></li>
<li>Advanced docker run options: <div class="fragment"><div class="line">docker run -i -t --rm \</div>
<div class="line">-e DISPLAY=unix$DISPLAY -v /tmp/.X11-unix:/tmp/.X11-unix \</div>
<div class="line">-v /local\_workdir:/image\_workdir \</div>
<div class="line">sndsw /bin/bash</div>
</div><!-- fragment --> The option <code>-e DISPLAY=unix$DISPLAY -v /tmp/.X11-unix:/tmp/.X11-unix</code> forwards graphics from the docker to your local system (similar to <code>ssh -X</code>). The option <code>-v /local_workdir:/image_workdir</code> mounts <code>/local_workdir</code> on the local system as <code>/image_workdir</code> within docker. </li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
